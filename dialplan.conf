[custom-process-call]
exten => 1,1,AGI(hichat-agi/getData.py,${CHANNEL})
exten => 1,2,Answer()
exten => 1,3,Playback(/tmp/${BUCKET_MINIO}/saudacao)
exten => 1,4,Set(START_TIME=${EPOCH})
exten => 1,5,Set(CALLID=${UNIQUEID})
exten => 1,6,Set(CALLER=${CALLERID(num)})
exten => 1,7,MixMonitor(/tmp/call_${CALLID}_in.wav)
exten => 1,8,Wait(3)
exten => 1,9,WaitForSilence(500)
exten => 1,10,StopMixMonitor()
exten => 1,11,Set(CURRENT_TIME=${EPOCH})
exten => 1,12,Set(CALL_DURATION=$[${CURRENT_TIME} - ${START_TIME}])
exten => 1,13,NoOp(Duração da chamada: ${CALL_DURATION} segundos)
exten => 1,14,GotoIf($[${CALL_DURATION}>=180]?timeout,1,1:custom-send-audio,1,1)

[custom-send-audio]
exten => 1,1,NoOp(Iniciando o envio do áudio)
exten => 1,2,AGI(hichat-agi/process_call.py,${CALLID},${CALLER},${CHATVOICE_ID},${BUCKET_MINIO})
; Verifica se o arquivo de áudio foi criado
exten => 1,3,Set(AUDIO_EXISTS=${STAT(e,/tmp/call_${CALLID}_out.gsm)})
exten => 1,4,NoOp(Arquivo de áudio existe: ${AUDIO_EXISTS})
exten => 1,5,GotoIf($["${AUDIO_EXISTS}"="0"]?no_audio)
; Toca o áudio de resposta
exten => 1,6,Playback(/tmp/call_${CALLID}_out)
; Verifica variáveis setadas pelo AGI (CLOSING e HUNGRUP)
exten => 1,7,NoOp(CLOSING=${CLOSING}, HUNGRUP=${HUNGRUP}, TRANSFER=${TRANSFER_CONFIRMADA})
exten => 1,8,GotoIf($["${CLOSING}"="True"]?prolonged-silence,1,1)
exten => 1,9,GotoIf($["${HUNGRUP}"="True"]?turning-off-now,1,1)
; Verifica se deve transferir para formulário
exten => 1,10,GotoIf($["${TRANSFER_CONFIRMADA}"="true"]?set_form_vars)
; Volta para gravar mais áudio
exten => 1,11,Goto(custom-process-call,1,7)
; Sem áudio - verifica status
exten => no_audio,1,NoOp(Arquivo de áudio não encontrado)
exten => no_audio,2,GotoIf($["${CLOSING}"="True"]?prolonged-silence,1,1)
exten => no_audio,3,GotoIf($["${HUNGRUP}"="True"]?turning-off-now,1,1)
exten => no_audio,4,Goto(custom-process-call,1,7)
; Define variáveis e inicia formulário
exten => set_form_vars,1,Set(form_index=0)
 same => n,Set(form_count=${FORM_COUNT})
 same => n,NoOp(Iniciando formulário com ${form_count} campos)
 same => n,Goto(custom-form-process,s,1)

; Avisar sobre o silêncio prolongado
[prolonged-silence]
exten => 1,1,Playback(/tmp/${BUCKET_MINIO}/silencio)
exten => 1,2,Goto(custom-process-call,1,7)

; Iniciando desligamento
[turning-off-now]
exten => 1,1,Playback(/tmp/${BUCKET_MINIO}/timeout)
exten => 1,2,Hangup()

[timeout]
exten => 1,1,Playback(/tmp/${BUCKET_MINIO}/finalizacao)
exten => 1,2,Hangup()

[custom-form-process]
exten => s,1,Playback(/tmp/${BUCKET_MINIO}/transfer)
exten => s,2,NoOp(Início do processo do formulário)
 same => n,Set(current_audio=${FORM_AUDIO_${form_index}})
 same => n,Set(current_type=${FORM_TYPE_${form_index}})
 same => n,NoOp(Tocando áudio: ${current_audio}, Tipo: ${current_type})
 same => n,Playback(/tmp/${BUCKET_MINIO}/${current_audio})
 ; Inicia gravação da resposta
 same => n,MixMonitor(/tmp/response_${CALLID}_${current_type}.wav)
 same => n,Wait(3)
 same => n,WaitForSilence(500)
 same => n,StopMixMonitor()
 ; Chama AGI para processar a resposta
 same => n,AGI(hichat-agi/form_transfer.py,${CALLID},${CALLER},${CHATVOICE_ID},${BUCKET_MINIO},${current_type},${IF($[${form_index} = $[${form_count} - 1]]?true:false)})
 ; Verifica se é o último áudio
 same => n,GotoIf($[${form_index} = $[${form_count} - 1]]?fim:proximo)
 same => n(proximo),Set(form_index=$[${form_index} + 1])
 same => n,Goto(s,2)
 same => n(fim),NoOp(Formulário concluído)
 same => n,Goto(custom-transfer,1,1)

[custom-transfer]
exten => 1,1,NoOp(Transferindo para grupo de fila via ramal)
exten => 1,2,Set(PJSIP_HEADER(add,Refer-To)=sip:9654@ip.b24-1854-1696607410.bitrixphone.com)
exten => 1,3,Transfer(PJSIP/<sip:9654@ip.b24-1854-1696607410.bitrixphone.com>)
exten => 1,4,Gosub(custom-hangup-handler,s,1)

[custom-hangup-handler]
exten => s,1,NoOp(Gerenciando encerramento personalizado)
exten => s,2,Playback(/tmp/${BUCKET_MINIO}/timeout)
exten => s,3,Return()
