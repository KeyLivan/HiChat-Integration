[custom-process-call]
exten => 1,1,AGI(hichat-agi/getData.py,${CHANNEL})
exten => 1,2,Answer()
exten => 1,3,Playback(/tmp/${BUCKET_MINIO}/saudacao)
exten => 1,4,Set(START_TIME=${EPOCH})
exten => 1,5,Set(CALLID=${UNIQUEID})
exten => 1,6,Set(CALLER=${CALLERID(num)})
exten => 1,n(record),MixMonitor(/tmp/call_${CALLID}_in.wav)
exten => 1,n,Wait(3)
exten => 1,n,WaitForSilence(500)
exten => 1,n,StopMixMonitor()
exten => 1,n,Set(CURRENT_TIME=${EPOCH})
exten => 1,n,Set(CALL_DURATION=$[${CURRENT_TIME} - ${START_TIME}])
exten => 1,n,NoOp(Duração da chamada: ${CALL_DURATION} segundos)
exten => 1,n,GotoIf($[${CALL_DURATION}>=180]?timeout,1,1)
exten => 1,n,Goto(custom-send-audio,1,1)

[custom-send-audio]
exten => 1,1,NoOp(Iniciando o envio do áudio)
exten => 1,n,AGI(hichat-agi/process_call.py,${CALLID},${CALLER},${CHATVOICE_ID},${BUCKET_MINIO})
exten => 1,n,NoOp(CLOSING=${CLOSING} HUNGRUP=${HUNGRUP} TRANSFER=${TRANSFER_CONFIRMADA})
; Verifica se o arquivo de áudio foi criado
exten => 1,n,Set(AUDIO_EXISTS=${STAT(e,/tmp/call_${CALLID}_out.gsm)})
exten => 1,n,NoOp(Arquivo de áudio existe: ${AUDIO_EXISTS})
exten => 1,n,GotoIf($["${AUDIO_EXISTS}"="0"]?check_status)
; Toca o áudio de resposta
exten => 1,n,Playback(/tmp/call_${CALLID}_out)
exten => 1,n(check_status),NoOp(Verificando status)
; Verifica variáveis setadas pelo AGI
exten => 1,n,GotoIf($["${CLOSING}"="True"]?prolonged-silence,1,1)
exten => 1,n,GotoIf($["${HUNGRUP}"="True"]?turning-off-now,1,1)
; Verifica se deve transferir para formulário
exten => 1,n,GotoIf($["${TRANSFER_CONFIRMADA}"="true"]?set_form_vars,1,1)
; Volta para gravar mais áudio
exten => 1,n,Goto(custom-process-call,1,record)

; Define variáveis e inicia formulário
[set_form_vars]
exten => 1,1,Set(form_index=0)
exten => 1,n,Set(form_count=${FORM_COUNT})
exten => 1,n,NoOp(Iniciando formulário com ${form_count} campos)
exten => 1,n,Goto(custom-form-process,s,1)

; Avisar sobre o silêncio prolongado
[prolonged-silence]
exten => 1,1,Playback(/tmp/${BUCKET_MINIO}/silencio)
exten => 1,n,Goto(custom-process-call,1,record)

; Iniciando desligamento
[turning-off-now]
exten => 1,1,Playback(/tmp/${BUCKET_MINIO}/timeout)
exten => 1,n,Hangup()

[timeout]
exten => 1,1,Playback(/tmp/${BUCKET_MINIO}/finalizacao)
exten => 1,n,Hangup()

[custom-form-process]
exten => s,1,Playback(/tmp/${BUCKET_MINIO}/transfer)
exten => s,n,NoOp(Início do processo do formulário)
exten => s,n,Set(current_audio=${FORM_AUDIO_${form_index}})
exten => s,n,Set(current_type=${FORM_TYPE_${form_index}})
exten => s,n,NoOp(Tocando áudio: ${current_audio}, Tipo: ${current_type})
exten => s,n,Playback(/tmp/${BUCKET_MINIO}/${current_audio})
; Inicia gravação da resposta
exten => s,n,MixMonitor(/tmp/response_${CALLID}_${current_type}.wav)
exten => s,n,Wait(3)
exten => s,n,WaitForSilence(500)
exten => s,n,StopMixMonitor()
; Chama AGI para processar a resposta
exten => s,n,AGI(hichat-agi/form_transfer.py,${CALLID},${CALLER},${CHATVOICE_ID},${BUCKET_MINIO},${current_type},${IF($[${form_index} = $[${form_count} - 1]]?true:false)})
; Verifica se é o último áudio
exten => s,n,GotoIf($[${form_index} = $[${form_count} - 1]]?fim)
exten => s,n,Set(form_index=$[${form_index} + 1])
exten => s,n,Goto(s,1)
exten => s,n(fim),NoOp(Formulário concluído)
exten => s,n,Goto(custom-transfer,1,1)

[custom-transfer]
exten => 1,1,NoOp(Transferindo para grupo de fila via ramal)
exten => 1,n,Set(PJSIP_HEADER(add,Refer-To)=sip:9654@ip.b24-1854-1696607410.bitrixphone.com)
exten => 1,n,Transfer(PJSIP/<sip:9654@ip.b24-1854-1696607410.bitrixphone.com>)
exten => 1,n,Gosub(custom-hangup-handler,s,1)

[custom-hangup-handler]
exten => s,1,NoOp(Gerenciando encerramento personalizado)
exten => s,n,Playback(/tmp/${BUCKET_MINIO}/timeout)
exten => s,n,Return()
