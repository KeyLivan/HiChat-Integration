[custom-process-call]
exten => 1,1,AGI(hichat-agi/getData.py,${CHANNEL})
exten => 1,2,Answer()
exten => 1,3,Playback(/tmp/${BUCKET_MINIO}/saudacao)
exten => 1,4,Set(START_TIME=${EPOCH})
exten => 1,5,Set(CALLID=${UNIQUEID})
exten => 1,6,Set(CALLER=${CALLERID(num)})
exten => 1,7,MixMonitor(/tmp/call_${CALLID}_in.wav)
exten => 1,8,Wait(3)
exten => 1,9,Set(CURRENT_TIME=${EPOCH})
exten => 1,10,NoOp(Tempo atual da chamada: ${CALL_DURATION} segundos.)
exten => 1,11,WaitForSilence(500)
exten => 1,12,StopMixMonitor()
exten => 1,13,Set(CALL_DURATION=$[${CURRENT_TIME} - ${START_TIME}])
exten => 1,14,GotoIf($[${CALL_DURATION}>=180]?timeout,1,1:custom-send-audio,1,1)

[custom-send-audio]
exten => 1,1,NoOp(Iniciando o envio do áudio)
exten => 1,2,AGI(hichat-agi/process_call.py,${CALLID},${CALLER},${CHATVOICE_ID},${BUCKET_MINIO})
exten => 1,3,Set(TALK_DETECT(set)=on)
exten => 1,4,Set(CHANNEL(hangup_handler_push)=fala-detectada,s,1)
exten => 1,5,Background(/tmp/call_${CALLID}_out)
; Verifica variáveis setadas pelo AGI (CLOSING e HUNGRUP)
exten => 1,6,GotoIf($["${CLOSING}"="True"]?prolonged-silence,1,1:custom-send-audio,1,7)
exten => 1,7,GotoIf($["${HUNGRUP}"="True"]?turning-off-now,1,1:custom-send-audio,1,8)
; Verifica se deve transferir para formulário
exten => 1,8,GotoIf($["${TRANSFER_CONFIRMADA}"="true"]?set_form_vars:custom-process-call,1,7)
; Define variáveis e inicia formulário
exten => set_form_vars,1,Set(form_index=0)
 same => n,Set(form_count=${FORM_COUNT})
 same => n,Goto(custom-form-process,s,1)
; Fallback
exten => 1,9,Hangup()

[fala-detectada]
exten => s,1,NoOp(Fala detectada — interrompendo e redirecionando)
 same => n,StopPlayTones()
 same => n,SoftHangup(${CHANNEL})
 same => n,Goto(custom-process-call,1,7)

; Avisar sobre o silêncio prolongado
[prolonged-silence]
exten => 1,1,Playback(/tmp/${BUCKET_MINIO}/silencio)
exten => 1,2,Goto(custom-process-call,1,7)

; Iniciando desligamento
[turning-off-now]
exten => 1,1,Playback(/tmp/${BUCKET_MINIO}/timeout)
exten => 1,2,Hangup()

[timeout]
exten => 1,1,Playback(/tmp/${BUCKET_MINIO}/finalizacao)
exten => 1,2,Hangup()

[custom-form-process]
exten => s,1,Playback(/tmp/${BUCKET_MINIO}/transfer)
exten => s,2,NoOp(Início do processo do formulário)
 same => n,Set(current_audio=${FORM_AUDIO_${form_index}})
 same => n,Set(current_type=${FORM_TYPE_${form_index}})
 same => n,NoOp(Tocando áudio: ${current_audio}, Tipo: ${current_type})
 same => n,Playback(/tmp/${BUCKET_MINIO}/${current_audio})
 ; Inicia gravação da resposta
 same => n,MixMonitor(/tmp/response_${CALLID}_${current_type}.wav)
 same => n,Wait(3)
 same => n,WaitForSilence(500)
 same => n,StopMixMonitor()
 ; Chama AGI para processar a resposta
 same => n,AGI(hichat-agi/form_transfer.py,${CALLID},${CALLER},${CHATVOICE_ID},${BUCKET_MINIO},${current_type},${IF($[${form_index} = $[${form_count} - 1]]?true:false)})
 ; Verifica se é o último áudio
 same => n,GotoIf($[${form_index} = $[${form_count} - 1]]?fim:proximo)
 same => n(proximo),Set(form_index=$[${form_index} + 1])
 same => n,Goto(s,2)
 same => n(fim),NoOp(Formulário concluído)
 same => n,Goto(custom-transfer,1,1)

[custom-transfer]
exten => 1,1,NoOp(Transferindo para grupo de fila via ramal)
exten => 1,2,Set(PJSIP_HEADER(add,Refer-To)=sip:9654@ip.b24-1854-1696607410.bitrixphone.com)
exten => 1,3,Transfer(PJSIP/<sip:9654@ip.b24-1854-1696607410.bitrixphone.com>)
exten => 1,4,Gosub(custom-hangup-handler,s,1)

[custom-hangup-handler]
exten => s,1,NoOp(Gerenciando encerramento personalizado)
exten => s,2,Playback(/tmp/${BUCKET_MINIO}/timeout)
exten => s,3,Return()
